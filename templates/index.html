<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python OPC UA Server Simulator</title>
    
    <!-- Siemens iX Design System Local Files -->
    <!-- Load the main iX component library -->
    <script type="module" src="{{ url_for('static', filename='ix/ix.esm.js') }}"></script>
    
    <!-- Configure global settings for iX, specifically the icon path -->
    <script type="module">
      // Import setGlobalConfig from the loaded iX library's module
      // The path must be absolute from the web server root or correctly relative.
      // '/static/ix/ix.esm.js' is the direct path for Flask's static files.
      import { setGlobalConfig } from '/static/ix/ix.esm.js'; 
      
      // Set the base URL where iX components should look for SVG icon files.
      // The trailing slash in 'ix-icons/svg/' is crucial.
      setGlobalConfig({
        iconsUrl: "{{ url_for('static', filename='ix-icons/svg/') }}"
      });
    </script>

    <!-- Load the iX Lumen theme CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='ix/theme/lumen.css') }}">

    <style>
        /* General layout styles - iX handles component styling */
        body { 
            font-family: var(--ix-font-family); 
            background-color: var(--ix-color-neutral-10); 
            color: var(--ix-color-content-primary); 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh; /* Ensure body takes full height for header positioning */
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            padding-top: 60px; /* Adjust for fixed header */
        }
        
        /* Form and grid layouts */
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            align-items: end; 
        }
        .server-list { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px; 
        }
        .server-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--ix-color-neutral-30); 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
        }
        .server-header-controls { 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        .endpoint-url { 
            font-family: 'Courier New', Courier, monospace; 
            font-size: 0.9em; 
            color: var(--ix-color-content-secondary); 
            background-color: var(--ix-color-neutral-20); 
            padding: 2px 6px; 
            border-radius: 4px; 
            word-break: break-all;
        }
        .data-container { 
            margin-top: 15px; 
            display: none; 
        }
        .data-tables { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 20px; 
            margin-top: 10px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th, td { 
            text-align: left; 
            padding: 8px; 
            border-bottom: 1px solid var(--ix-color-neutral-30); 
        }
        thead th { 
            background-color: var(--ix-color-neutral-20); 
        }
        
        /* Specific adjustments for iX components within the layout */
        ix-application-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000; /* Ensure it stays on top */
        }

        /* Overrides/helpers for things not directly covered by iX components */
        .status-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <ix-application-header>
        <ix-breadcrumb-item>Python OPC UA Server Simulator</ix-breadcrumb-item>
    </ix-application-header>

    <div class="container">
        <ix-card>
            <ix-headline size="5">Create New OPC UA Server</ix-headline>
            <form id="create-server-form" class="form-grid">
                <div>
                    <ix-input label="TCP Port" type="number" id="port" value="4840" required></ix-input>
                </div>
                <div>
                    <ix-input label="Server Name" type="text" id="name" value="GT01" required></ix-input>
                </div>
                <div>
                    <ix-input label="Endpoint Path" type="text" id="endpoint_path" value="/simulator/server" required></ix-input>
                </div>
                <ix-button type="submit" variant="primary">Create Server</ix-button>
            </form>
        </ix-card>
        <div class="server-list" id="servers-container"></div>
    </div>
    <script>
        const API_BASE = '/api';
        const serversContainer = document.getElementById('servers-container');
        const createForm = document.getElementById('create-server-form');

        async function loadServers() {
            const response = await fetch(`${API_BASE}/servers`);
            const servers = await response.json();
            
            serversContainer.innerHTML = '';
            servers.forEach(server => renderServerCard(server));
        }

        function renderServerCard(server) {
            const card = document.createElement('ix-card');
            
            const statusText = server.is_running ? 'Running' : 'Stopped';
            const statusColor = server.is_running ? 'success' : 'danger'; // iX badge colors

            card.innerHTML = `
                <div class="server-header">
                    <div>
                        <ix-headline size="6">${server.name}</ix-headline>
                        <div class="endpoint-url">${server.endpoint_url}</div>
                    </div>
                    <div class="server-header-controls">
                        <span class="status-wrapper"><ix-badge variant="${statusColor}" rounded></ix-badge>${statusText}</span>
                        <ix-button variant="secondary" class="btn-refresh" data-port="${server.port}">Refresh Data</ix-button>
                        <ix-button variant="secondary" class="btn-collapse" data-port="${server.port}">Expand</ix-button>
                        <ix-button variant="danger" class="btn-delete" data-port="${server.port}">Delete</ix-button>
                    </div>
                </div>
                <div class="data-container" id="data-container-${server.port}"></div>
            `;
            serversContainer.appendChild(card);
        }

        async function loadServerData(port) {
            const container = document.getElementById(`data-container-${port}`);
            if (!container) return;
            const response = await fetch(`${API_BASE}/servers/${port}/data`);
            if (!response.ok) {
                alert('Failed to load server data.');
                return;
            }
            const data = await response.json();
            renderDataTables(port, data);
        }

        function renderDataTables(port, data) {
            const container = document.getElementById(`data-container-${port}`);
            if (!container) return;

            const genTable = (title, typeKey, points) => {
                const isDigital = typeKey.includes('digital');
                const isInput = typeKey.includes('_input_vars'); 

                const rows = Object.entries(points).map(([name, data]) => {
                    const value = data.value;
                    const desc = data.desc || '';
                    
                    let valueCell;
                    
                    if (isInput) {
                        // For Input variables, display as plain text (read-only)
                        valueCell = `<span>${isDigital ? (value ? 'ON' : 'OFF') : value}</span>`;
                    } else {
                        // For Output variables, use interactive iX components
                        if (isDigital) {
                            valueCell = `<ix-toggle 
                                              size="m" 
                                              data-port="${port}" 
                                              data-type="${typeKey}" 
                                              data-name="${name}" 
                                              ${value ? 'checked' : ''}>
                                          </ix-toggle>`;
                        } else {
                            // Analog Output: Use ix-input for editing directly
                            valueCell = `<ix-input 
                                              value="${value}" 
                                              type="number" 
                                              step="any" 
                                              data-port="${port}" 
                                              data-type="${typeKey}" 
                                              data-name="${name}"
                                              class="editable-ix-input"
                                          ></ix-input>`;
                        }
                    }
                    
                    return `<tr><td>${name}</td><td>${desc}</td><td>${valueCell}</td></tr>`;
                }).join('');
                
                return `
                    <div>
                        <ix-headline size="7">${title}</ix-headline>
                        <table>
                            <thead><tr><th>Name</th><th>Description</th><th>Value</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
            };

            container.innerHTML = `<div class="data-tables">
                ${genTable('Analog Input', 'analog_input_vars', data.analog_input_vars)}
                ${genTable('Analog Output', 'analog_output_vars', data.analog_output_vars)}
                ${genTable('Digital Input', 'digital_input_vars', data.digital_input_vars)}
                ${genTable('Digital Output', 'digital_output_vars', data.digital_output_vars)}
            </div>`;
            container.style.display = 'grid'; // Ensure the data container is visible
        }
        
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Get values from iX input components using .value property
            const endpointPath = createForm.querySelector('#endpoint_path').value;
            const portInput = createForm.querySelector('#port');
            const nameInput = createForm.querySelector('#name');

            if (!endpointPath.startsWith('/')) {
                alert('Endpoint Path must start with a forward slash (/).');
                return;
            }

            const payload = { 
                port: parseInt(portInput.value), 
                name: nameInput.value,
                endpoint_path: endpointPath
            };
            
            const response = await fetch(`${API_BASE}/servers`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const err = await response.json();
                alert(`Error: ${err.error}`);
            } else {
                portInput.value = payload.port + 1; // Increment for next creation
                loadServers();
            }
        });

        // Event delegation for iX components
        serversContainer.addEventListener('click', async (e) => {
            const target = e.target;

            // Handle ix-button clicks
            const button = target.closest('ix-button');
            if (button) {
                const { port } = button.dataset;
                if (button.classList.contains('btn-delete')) {
                    if (confirm(`Delete server on Port ${port}?`)) {
                        await fetch(`${API_BASE}/servers/${port}`, { method: 'DELETE' });
                        loadServers();
                    }
                } else if (button.classList.contains('btn-refresh')) {
                    button.loading = true; // Show loading spinner
                    try {
                        await loadServerData(port);
                        button.closest('.server-header-controls').querySelector('.btn-collapse').textContent = 'Collapse';
                    } finally {
                        button.loading = false;
                    }
                } else if (button.classList.contains('btn-collapse')) {
                    const dataContainer = document.getElementById(`data-container-${port}`);
                    if (dataContainer.style.display === 'none') {
                        button.textContent = 'Collapse';
                        dataContainer.style.display = 'grid';
                        if (dataContainer.innerHTML === '') {
                           // Trigger refresh if expanded for the first time
                           button.closest('.server-header-controls').querySelector('.btn-refresh').click();
                        }
                    } else {
                        button.textContent = 'Expand';
                        dataContainer.style.display = 'none';
                    }
                }
                return;
            }

            // Handle ix-toggle changes (Digital Output)
            if (target.tagName === 'IX-TOGGLE') {
                const toggle = target;
                const port = toggle.dataset.port;
                const type = toggle.dataset.type; 
                const name = toggle.dataset.name;
                const newValue = toggle.checked; // iX toggle uses 'checked' property
                
                await updateServerValue(port, type, name, newValue);
                return;
            }

            // Handle ix-input changes (Analog Output)
            // Listen for 'change' event on ix-input to capture value updates
            // (input elements inside the shadow DOM of ix-input might not bubble 'input' directly)
            if (target.tagName === 'IX-INPUT' && target.classList.contains('editable-ix-input')) {
                // To get the actual value when the user finishes editing, listen to the 'change' event
                // This will fire when the input loses focus or Enter is pressed.
                // We'll attach a one-time listener for the 'change' event.
                target.addEventListener('change', async function handler(e) {
                    const input = e.target;
                    const port = input.dataset.port;
                    const type = input.dataset.type;
                    const name = input.dataset.name;
                    const newValue = parseFloat(input.value);

                    if (!isNaN(newValue)) {
                        await updateServerValue(port, type, name, newValue);
                    } else {
                        // Revert to original value if invalid input, or fetch fresh data
                        console.error('Invalid number input, reverting...');
                        await loadServerData(port); // Simplest way to revert is to reload data
                    }
                    input.removeEventListener('change', handler); // Remove self
                }, { once: true });
                return;
            }
        });

        // Helper function to update server values
        async function updateServerValue(port, type, name, value) {
            try {
                const payload = { type, name, value };
                const response = await fetch(`${API_BASE}/servers/${port}/data`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    console.error('Failed to update server value');
                    // Reload data on error to show actual state from server
                    await loadServerData(port); 
                }
            } catch (error) {
                console.error('Error updating server value:', error);
                await loadServerData(port); // Reload data on network error
            }
        }

        document.addEventListener('DOMContentLoaded', loadServers);
    </script>
</body>
</html>